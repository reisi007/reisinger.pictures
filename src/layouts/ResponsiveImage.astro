---
import { Image } from "astro:assets";
import { type JSX } from "astro/jsx-runtime";
import { getImageImportNameByPossiblyRelativeName, tryGetImageByAbsoluteName } from "../images/Images";
import type { NumericBreakpoints } from "../styles/Breakpoints";
import { computeSizes, DEFAULT_IMAGE_SIZES, mergeBreakpoints } from "../styles/Breakpoints";
import { ResponsiveImageLoading } from "./ResponsiveImageLoading";
import { GALLERY_BREAKPOINTS, GalleryLayout } from "./GalleryLayout";
import { getAltFromAbsoluteName } from "./image.utils";

interface Props {
  name: string,
  class?: string,
  style?: JSX.CSSProperties,
  height?: string,
  sizes?: string,
  widths?: number[],
  loading?: ResponsiveImageLoading,
  sizeModifiers?: Partial<NumericBreakpoints>
}

const {
  name,
  sizes,
  sizeModifiers,
  widths: widthsOverride,
  height = "80vh",
  loading = ResponsiveImageLoading.LAZY,
  class: clazz,
  style,
  ...other
} = Astro.props;

const absoluteName = getImageImportNameByPossiblyRelativeName(name);
const imagePromise = tryGetImageByAbsoluteName(absoluteName);
if (imagePromise === undefined) throw new Error(`Image "${name}" not found.`);
const image = (await imagePromise).default;
const alt = await getAltFromAbsoluteName(absoluteName);
const computedSizes = computeSizes(mergeBreakpoints(GALLERY_BREAKPOINTS[GalleryLayout.Full], sizeModifiers));
const widths: number[] = (widthsOverride ?? DEFAULT_IMAGE_SIZES).filter(s => s <= image.width);

const maxOptimizedWidth = widths[widths.length - 1];
const maxOptimizedHeight = maxOptimizedWidth * image.height / image.width;
---
<Image
  format="avif"
  class={clazz}
  quality="med"
  loading={loading}
  widths={widths}
  sizes={sizes ?? computedSizes}
  data-pswp-width={maxOptimizedWidth}
  data-pswp-height={maxOptimizedHeight}
  src={image}
  alt={alt}
  {...other}
/>
