---
import { getImage } from "astro:assets";
import type { CollectionEntry } from "astro:content";

import { getImage as getImageByName } from "../../images/Images";
import { LARGEST_IMAGE_SIZE } from "../../styles/Breakpoints";
import { absoluteLink } from "../../utils";
import BaseHead from "../BaseHead.astro";
import Published from "../Published.astro";
import ResponsiveImage from "../ResponsiveImage.astro";
import type { SchemaCreationFunction } from "../SchemaOrg";
import SchemaOrg from "../SchemaOrg.astro";
import { createBlogPostingSchema } from "../SchemaOrg.factory";
import SocialImage from "../SocialImage.astro";
import MinimalPage from "./MinimalPage.astro";

type Props = CollectionEntry<"einblicke">["data"] | CollectionEntry<"courses">["data"];

const { title, description, heroImage, ...dates } = Astro.props;

const imageInfo = await getImage({
  src: getImageByName(heroImage),
  format: "webp",
  width: LARGEST_IMAGE_SIZE,
  fit: "scale-down"
});

const date = "date" in dates ? dates.date : undefined;
const updated = "updated" in dates ? dates.updated : undefined;

const schemaOrg: SchemaCreationFunction = (o, me, df, url) => createBlogPostingSchema({
  url,
  headline: title,
  description: description,
  image: absoluteLink(Astro.url, imageInfo.src),
  author: me,
  publisher: o,
  datePublished: df(date),
  dateModified: df(updated)
});
---

<MinimalPage>
  <BaseHead slot="head" title={title} description={description}>
    <SocialImage name={heroImage} />
    <SchemaOrg createData={schemaOrg} />
  </BaseHead>
  <article>
    <section>
      <h1>{title}</h1>
      <Published date={date} updated={updated} />
      {heroImage &&
        <div>
          <ResponsiveImage name={heroImage} alt={title} height="32rem" />
        </div>}
    </section>
    <hr />
    <slot name="start"></slot>
    <div data-toc />
    <slot />
  </article>
</MinimalPage>
